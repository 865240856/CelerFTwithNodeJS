# NGINX configuration file that is used with CelerFT

server {
    listen       443 ssl http2 reuseport;
    server_name  www.celerfthttp2test.com ;

    # Enable SSL
    ssl on;
    ssl_certificate /etc/nginx/ssl/selfsigned/selfsignedserver.crt;
    ssl_certificate_key /etc/nginx/ssl/selfsigned/selfsignedserver.key;

    #ssl_ciphers     HIGH:!aNULL:!MD5;
    ssl_ciphers     AES128+EECDH:AES128+EDH:!aNULL;

    ssl_protocols   TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache shared:SSL:10m;

    #ssl_stapling on;
    #ssl_stapling_verify on;
    resolver 8.8.4.4 8.8.8.8 valid=300s;
    resolver_timeout 10s;

    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    #add_header Strict-Transport-Security max-age=63072000;
    #add_header X-Frame-Options DENY;
    #add_header X-Content-Type-Options nosniff;

    server_tokens off;
    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Xss-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Content-Security-Policy "default-src https: data: 'unsafe-inline' 'unsafe-eval'" always;

    # redirect CelerFT
    location  = /api/CelerFTFileUpload/UploadChunk/XFileName {
       aio on;
       directio 10M;
       client_body_temp_path      /tmp/nginx 1;
       #client_body_temp_path       /usr/share/nginx/html/CelerFT/temp_uploads;
       client_body_in_file_only   on;
       client_body_buffer_size    10M;
       client_max_body_size 60M;

       proxy_pass_request_headers on;
       proxy_set_body             off;
       proxy_redirect             off;
       proxy_ignore_client_abort  on;
       proxy_http_version         1.1;
       proxy_set_header           Connection "";
       proxy_set_header           Host $host;
       ##proxy_set_header         Host $http_host;
       proxy_set_header           X-Real-IP $remote_addr;
       proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header           X-Forwarded-Proto $scheme;
       proxy_set_header           X-File-Name $request_body_file;
       proxy_pass                 http://127.0.0.1:1337;
      # proxy_redirect             default;

       proxy_connect_timeout       600;
       proxy_send_timeout          600;
       proxy_read_timeout          600;
       send_timeout                600;

       access_log                  off;
       error_log                  /var/log/nginx/nginx.upload.error.log;

   }

}
